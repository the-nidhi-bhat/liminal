<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalmCompanion - Enhanced AI Chatbot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        :root {
            --bg-card: rgba(255, 255, 255, 0.95);
            --bg-input: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border-color: #e5e7eb;
            --border-color-focus: #8b5cf6;
            --shadow: rgba(0, 0, 0, 0.08);
            --bot-msg-bg: linear-gradient(135deg, #f8fafc, #f1f5f9);
            --bot-msg-border: #e2e8f0;
            --user-msg-bg: linear-gradient(135deg, #8b5cf6, #6366f1);
            --scrollbar-track: #f1f5f9;
            --scrollbar-thumb: #cbd5e1;
        }

        body {
            min-height: 100vh;
            background:
              linear-gradient(135deg, rgba(236, 72, 153, 0.16), rgba(59, 130, 246, 0.18)),
              url('image.jpg') center/cover fixed no-repeat;
            padding: 16px;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }

        body.dark-mode {
            --bg-card: rgba(30, 41, 59, 0.95);
            --bg-input: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --border-color-focus: #a78bfa;
            --shadow: rgba(0, 0, 0, 0.3);
            --bot-msg-bg: linear-gradient(135deg, #1e293b, #334155);
            --bot-msg-border: #475569;
            --user-msg-bg: linear-gradient(135deg, #7c3aed, #6366f1);
            --scrollbar-track: #1e293b;
            --scrollbar-thumb: #475569;

            background:
              linear-gradient(135deg, rgba(17, 24, 39, 0.9), rgba(30, 41, 59, 0.9)),
              url('night.jpg') center/cover fixed no-repeat;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            width: 100%;
            max-width: 500px;
            background: var(--bg-card);
            backdrop-filter: blur(24px);
            border-radius: 28px;
            padding: 32px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            border: 2px solid var(--border-color);
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .modal-subtitle {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px 16px;
            border-radius: 12px;
            border: 2px solid var(--border-color);
            font-size: 14px;
            background: var(--bg-input);
            color: var(--text-primary);
            transition: all 0.2s;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: var(--border-color-focus);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.15);
        }

        .modal-btn {
            width: 100%;
            padding: 14px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: #ffffff;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 16px rgba(139, 92, 246, 0.3);
            margin-top: 12px;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px rgba(139, 92, 246, 0.4);
        }

        .modal-btn.secondary {
            background: transparent;
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            box-shadow: none;
        }

        .slider-container {
            margin: 16px 0;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 5px;
            background: var(--border-color);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #8b5cf6;
            cursor: pointer;
        }

        /* Breathing Exercise Circle */
        .breath-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            margin: 30px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: 700;
            transition: transform 4s ease-in-out;
        }

        .breath-circle.inhale {
            transform: scale(1.5);
        }

        .breath-circle.hold {
            transform: scale(1.5);
        }

        .breath-circle.exhale {
            transform: scale(1);
        }

        /* Assessment Radio Options */
        .radio-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .radio-option {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-input);
        }

        .radio-option:hover {
            border-color: var(--border-color-focus);
        }

        .radio-option input {
            margin-right: 8px;
        }

        .radio-option.selected {
            border-color: #8b5cf6;
            background: rgba(139, 92, 246, 0.1);
        }

        /* Resource Cards */
        .resource-card {
            padding: 16px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 12px;
            background: var(--bg-input);
            cursor: pointer;
            transition: all 0.2s;
        }

        .resource-card:hover {
            border-color: var(--border-color-focus);
            transform: translateY(-2px);
        }

        .resource-title {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .resource-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .achievement-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-size: 12px;
            font-weight: 700;
            margin: 4px;
            animation: popIn 0.3s ease;
        }

        @keyframes popIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Continue with all your existing styles... */
        .header {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 18px 24px;
            margin-bottom: 16px;
            box-shadow: 0 8px 24px var(--shadow);
            border: 1px solid var(--border-color);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .bot-info {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .bot-avatar-header {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 16px rgba(139, 92, 246, 0.3);
        }

        .bot-details h1 {
            font-size: 19px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .bot-status {
            font-size: 11px;
            color: #10b981;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
        }

        .icon-btn {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--bg-input);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-btn:hover {
            border-color: var(--border-color-focus);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.2);
        }

        .icon-btn.active {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            color: #ffffff;
            border-color: #8b5cf6;
        }

        .icon-btn.peer-btn {
            background: linear-gradient(135deg, #ec4899, #f43f5e);
            color: #ffffff;
            border-color: #ec4899;
        }

        .icon-btn.journey-btn {
            background: linear-gradient(135deg, #f59e0b, #f97316);
            color: #ffffff;
            border-color: #f59e0b;
        }

        /* Analytics */
        .analytics-bar {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 18px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px var(--shadow);
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .mood-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .mood-stat span {
            font-weight: 700;
            color: var(--text-primary);
        }

        .mood-chart-btn {
            padding: 8px 16px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            background: var(--bg-input);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
        }

        .mood-chart-btn:hover {
            border-color: var(--border-color-focus);
            transform: translateY(-2px);
        }

        /* Chat */
        .chat-container {
            background: var(--bg-card);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 8px 24px var(--shadow);
            border: 1px solid var(--border-color);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            scroll-behavior: smooth;
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 10px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 10px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: messageSlide 0.4s cubic-bezier(0.16, 1, 0.3, 1);
            opacity: 0;
            animation-fill-mode: forwards;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.bot {
            align-self: flex-start;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        .message-content {
            max-width: 70%;
            padding: 14px 18px;
            border-radius: 18px;
            font-size: 14px;
            line-height: 1.7;
            word-wrap: break-word;
        }

        .message.bot .message-content {
            background: var(--bot-msg-bg);
            border: 1px solid var(--bot-msg-border);
            color: var(--text-primary);
            border-radius: 18px 18px 18px 4px;
        }

        .message.user .message-content {
            background: var(--user-msg-bg);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.25);
            border-radius: 18px 18px 4px 18px;
        }

        .message-content.crisis-alert {
            background: linear-gradient(135deg, #fee2e2, #fecaca) !important;
            border: 2px solid #ef4444 !important;
            color: #7f1d1d !important;
            font-weight: 700;
        }

        .message-sentiment {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .suggested-replies {
            margin-top: 8px;
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .suggested-reply-btn {
            padding: 6px 12px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            background: var(--bg-input);
            font-size: 12px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggested-reply-btn:hover {
            border-color: var(--border-color-focus);
            background: rgba(139, 92, 246, 0.1);
        }

        .typing-indicator {
            display: none;
            padding: 10px 18px;
            background: var(--bot-msg-bg);
            border-radius: 18px;
            width: fit-content;
            border: 1px solid var(--bot-msg-border);
        }

        .typing-indicator.active {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: typingBounce 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-8px); }
        }

        .chat-input-area {
            padding: 20px 24px 12px;
            background: var(--bg-card);
            border-top: 1px solid var(--border-color);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 14px 18px;
            border-radius: 14px;
            border: 2px solid var(--border-color);
            font-size: 14px;
            background: var(--bg-input);
            color: var(--text-primary);
            transition: all 0.2s;
            resize: none;
            font-family: inherit;
            min-height: 50px;
            max-height: 120px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--border-color-focus);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .send-btn, .voice-btn {
            padding: 14px 20px;
            border-radius: 14px;
            border: none;
            color: #ffffff;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .send-btn {
            background: linear-gradient(135deg, #8b5cf6, #6366f1);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .voice-btn {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .voice-btn.recording {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .chip-btn {
            padding:6px 10px;
            border-radius:999px;
            border:1px solid var(--border-color);
            background:var(--bg-input);
            cursor:pointer;
            font-size:11px;
            color:var(--text-secondary);
        }

        .chip-btn:hover {
            border-color:var(--border-color-focus);
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .history-item {
            padding: 12px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 8px;
            background: var(--bg-input);
            font-size: 13px;
        }

        .history-date {
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .history-preview {
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .mood-chart {
            width: 100%;
            height: 250px;
            margin-bottom: 20px;
            position: relative;
        }

        .chart-bar {
            display: inline-block;
            width: calc(100% / 7 - 8px);
            background: linear-gradient(180deg, #8b5cf6, #6366f1);
            border-radius: 8px 8px 0 0;
            margin: 0 4px;
            vertical-align: bottom;
        }

        .offline-banner {
            background: #f59e0b;
            color: white;
            padding: 8px;
            text-align: center;
            font-size: 13px;
            font-weight: 600;
            display: none;
        }

        .offline-banner.active {
            display: block;
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .chat-container { height: calc(100vh - 150px); }
            .message-content { max-width: 85%; }
            .analytics-bar {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    

        /* ü§ñ FLOATING AI TOGGLE - Bottom Right Corner */
        .floating-ai-toggle {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 9999;
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            animation: pulse-ai 2s infinite;
        }

        .floating-ai-toggle:hover {
            transform: scale(1.15) rotate(10deg);
            box-shadow: 0 12px 36px rgba(16, 185, 129, 0.6);
        }

        .floating-ai-toggle:active {
            transform: scale(1.05);
        }

        .floating-ai-toggle.ai-off {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            box-shadow: 0 8px 24px rgba(107, 114, 128, 0.4);
        }

        .floating-ai-toggle.ai-off:hover {
            box-shadow: 0 12px 36px rgba(107, 114, 128, 0.6);
        }

        @keyframes pulse-ai {
            0%, 100% {
                box-shadow: 0 8px 24px rgba(16, 185, 129, 0.4);
            }
            50% {
                box-shadow: 0 8px 32px rgba(16, 185, 129, 0.7);
            }
        }

        .ai-status-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #10b981;
            border: 3px solid var(--bg-primary);
            animation: blink-badge 1.5s infinite;
        }

        .ai-status-badge.off {
            background: #ef4444;
        }

        @keyframes blink-badge {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Background image support */
        body {
            background-image: url('image.jpg');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }

        body.dark-mode {
            background-image: url('night.jpg');
        }

        /* Add slight backdrop blur to container for readability */
        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        body.dark-mode .container {
            background: rgba(30, 30, 30, 0.95);
        }
</style>
</head>
<body>
    <div class="offline-banner" id="offlineBanner">‚ö†Ô∏è You're offline - some features may not work</div>

    <!-- Voice Settings Modal -->
    <div class="modal-overlay" id="voiceSettingsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon">üéôÔ∏è</div>
                <h2 class="modal-title">Voice Settings</h2>
                <p class="modal-subtitle">Customize text-to-speech voice and controls</p>
            </div>
            <div class="form-group">
                <label class="form-label">Select Voice</label>
                <select class="form-select" id="voiceSelect"></select>
            </div>
            <div class="slider-container">
                <label class="form-label">Speech Rate: <span id="rateValue">1.0</span>x</label>
                <input type="range" class="slider" id="rateSlider" min="0.5" max="2" step="0.1" value="1">
            </div>
            <div class="slider-container">
                <label class="form-label">Pitch: <span id="pitchValue">1.0</span></label>
                <input type="range" class="slider" id="pitchSlider" min="0.5" max="2" step="0.1" value="1">
            </div>
            <button class="modal-btn" onclick="bot.testVoice()">Test Voice</button>
            <button class="modal-btn secondary" onclick="closeVoiceSettings()">Close</button>
        </div>
    </div>

    <!-- Bot Personality Modal -->
    <div class="modal-overlay" id="personalityModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon">ü§ñ</div>
                <h2 class="modal-title">Bot Personality</h2>
                <p class="modal-subtitle">Choose how I respond to you</p>
            </div>
            <div class="resource-card" onclick="bot.setPersonality('empathetic')">
                <div class="resource-title">üíú Empathetic & Warm</div>
                <div class="resource-desc">Gentle, understanding, focuses on emotions</div>
            </div>
            <div class="resource-card" onclick="bot.setPersonality('motivational')">
                <div class="resource-title">üí™ Motivational & Uplifting</div>
                <div class="resource-desc">Encouraging, action-oriented, energetic</div>
            </div>
            <div class="resource-card" onclick="bot.setPersonality('clinical')">
                <div class="resource-title">ü©∫ Clinical & Professional</div>
                <div class="resource-desc">Evidence-based, structured, therapeutic</div>
            </div>
            <button class="modal-btn secondary" onclick="closePersonalityModal()">Close</button>
        </div>
    </div>

    <!-- Emergency Contact Modal -->
    <div class="modal-overlay" id="emergencyModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon">üö®</div>
                <h2 class="modal-title">Emergency Contacts</h2>
                <p class="modal-subtitle">Quick access to crisis helplines</p>
            </div>
            <div class="resource-card" onclick="window.open('tel:+919820466726', '_self')">
                <div class="resource-title">üìû AASRA</div>
                <div class="resource-desc">+91 98204 66726 (24/7 Suicide Prevention)</div>
            </div>
            <div class="resource-card" onclick="window.open('tel:18602662345', '_self')">
                <div class="resource-title">üìû Vandrevala Foundation</div>
                <div class="resource-desc">1860-2662-345 (Mental Health Helpline)</div>
            </div>
            <div class="resource-card" onclick="window.open('tel:+919152987821', '_self')">
                <div class="resource-title">üìû iCall</div>
                <div class="resource-desc">+91 91529 87821 (Counseling Service)</div>
            </div>
            <div class="resource-card" onclick="window.open('tel:112', '_self')">
                <div class="resource-title">üöë Emergency Services</div>
                <div class="resource-desc">112 (National Emergency Number)</div>
            </div>
            <button class="modal-btn secondary" onclick="closeEmergencyModal()">Close</button>
        </div>
    </div>

    <!-- Achievements Modal -->
    <div class="modal-overlay" id="achievementsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon">üèÜ</div>
                <h2 class="modal-title">Your Achievements</h2>
                <p class="modal-subtitle">Celebrating your mental health journey</p>
            </div>
            <div id="achievementsList" style="margin-bottom: 20px;"></div>
            <button class="modal-btn secondary" onclick="closeAchievementsModal()">Close</button>
        </div>
    </div>

    <!-- Daily Affirmation Modal -->
    <div class="modal-overlay" id="affirmationModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-icon">‚ú®</div>
                <h2 class="modal-title">Daily Affirmation</h2>
                <p class="modal-subtitle" id="affirmationText"></p>
            </div>
            <button class="modal-btn" onclick="bot.getNewAffirmation()">Get Another</button>
            <button class="modal-btn secondary" onclick="closeAffirmationModal()">Close</button>
        </div>
    </div>

    <!-- All your existing modals from before... -->
    <!-- (I'm keeping them but shortening here for space - include ALL previous modals) -->


    <div class="modal-overlay" id="historyModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-icon">üìú</div><h2 class="modal-title">Chat History</h2><p class="modal-subtitle">Your conversation log</p></div>
            <div class="history-list" id="historyList"></div>
            <button class="modal-btn" onclick="bot.exportHistory()">üì• Export History</button>
            <button class="modal-btn secondary" onclick="closeHistoryModal()">Close</button>
        </div>
    </div>
    <div class="modal-overlay" id="analyticsModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-icon">üìä</div><h2 class="modal-title">Mood Trends</h2><p class="modal-subtitle">7-day mood visualization</p></div>
            <div class="mood-chart" id="moodChart"></div>
            <p id="weekSummary" style="font-size:13px; text-align:center; margin-top:16px; color:var(--text-secondary);"></p>
            <button class="modal-btn secondary" onclick="closeAnalyticsModal()">Close</button>
        </div>
    </div>
    <div class="modal-overlay" id="breathingModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-icon">üå¨Ô∏è</div><h2 class="modal-title">Breathing Exercise</h2><p class="modal-subtitle">4-7-8 technique for instant calm</p></div>
            <div class="breath-circle" id="breathCircle">Ready</div>
            <div style="text-align:center; font-weight:700; margin-top:8px;" id="breathInstruction">Press Start</div>
            <button class="modal-btn" id="startBreathBtn" onclick="bot.startBreathing()">‚ñ∂Ô∏è Start Breathing</button>
            <button class="modal-btn secondary" onclick="closeBreathingModal()">Close</button>
        </div>
    </div>
    <div class="modal-overlay" id="meditationModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-icon">üßò‚Äç‚ôÄÔ∏è</div><h2 class="modal-title">Guided Meditation</h2><p class="modal-subtitle">Choose your session length</p></div>
            <div class="resource-card" onclick="bot.startMeditation(3)"><div class="resource-title">‚è±Ô∏è 3 Minutes</div><div class="resource-desc">Quick calm for busy moments</div></div>
            <div class="resource-card" onclick="bot.startMeditation(5)"><div class="resource-title">‚è±Ô∏è 5 Minutes</div><div class="resource-desc">Mindfulness with body scan</div></div>
            <div class="resource-card" onclick="bot.startMeditation(10)"><div class="resource-title">‚è±Ô∏è 10 Minutes</div><div class="resource-desc">Deep relaxation session</div></div>
            <button class="modal-btn secondary" onclick="closeMeditationModal()">Close</button>
        </div>
    </div>
    <div class="modal-overlay" id="groundingModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-icon">üåø</div><h2 class="modal-title">5-4-3-2-1 Grounding</h2><p class="modal-subtitle">Anchor yourself to the present moment</p></div>
            <div class="form-group"><label class="form-label">üëÅÔ∏è 5 things you can SEE</label><input class="form-input" id="ground5" placeholder="e.g., table, fan, phone, wall, laptop" /></div>
            <div class="form-group"><label class="form-label">‚úã 4 things you can TOUCH</label><input class="form-input" id="ground4" placeholder="e.g., chair, desk, keyboard, mouse" /></div>
            <div class="form-group"><label class="form-label">üëÇ 3 things you can HEAR</label><input class="form-input" id="ground3" placeholder="e.g., traffic, fan, music" /></div>
            <div class="form-group"><label class="form-label">üëÉ 2 things you can SMELL</label><input class="form-input" id="ground2" placeholder="e.g., soap, coffee, fresh air" /></div>
            <div class="form-group"><label class="form-label">üëÖ 1 thing you can TASTE</label><input class="form-input" id="ground1" placeholder="e.g., water, mint, tea" /></div>
            <button class="modal-btn" onclick="bot.completeGrounding()">‚úÖ Complete Exercise</button>
            <button class="modal-btn secondary" onclick="closeGroundingModal()">Close</button>
        </div>
    </div>
    <div class="modal-overlay" id="phq9Modal">
        <div class="modal">
            <div class="modal-header"><div class="modal-icon">üìã</div><h2 class="modal-title">PHQ-9 Assessment</h2><p class="modal-subtitle">Depression screening ‚Ä¢ Over the last 2 weeks...</p></div>
            <div id="phq9Questions"></div>
            <button class="modal-btn" onclick="bot.calculatePHQ9()">üìä See Results</button>
            <button class="modal-btn secondary" onclick="closePHQ9Modal()">Close</button>
        </div>
    </div>
    <div class="modal-overlay" id="gad7Modal">
        <div class="modal">
            <div class="modal-header"><div class="modal-icon">üìã</div><h2 class="modal-title">GAD-7 Assessment</h2><p class="modal-subtitle">Anxiety screening ‚Ä¢ Over the last 2 weeks...</p></div>
            <div id="gad7Questions"></div>
            <button class="modal-btn" onclick="bot.calculateGAD7()">üìä See Results</button>
            <button class="modal-btn secondary" onclick="closeGAD7Modal()">Close</button>
        </div>
    </div>
    <div class="modal-overlay" id="copingModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-icon">üõ†Ô∏è</div><h2 class="modal-title">Coping Strategies</h2><p class="modal-subtitle">Evidence-based techniques for different challenges</p></div>
            <div class="resource-card" onclick="bot.showCopingCategory('anxiety')"><div class="resource-title">üò∞ Anxiety & Panic</div><div class="resource-desc">Breathing, grounding, progressive muscle relaxation</div></div>
            <div class="resource-card" onclick="bot.showCopingCategory('depression')"><div class="resource-title">üòî Low Mood & Depression</div><div class="resource-desc">Behavioral activation, self-compassion, connection</div></div>
            <div class="resource-card" onclick="bot.showCopingCategory('stress')"><div class="resource-title">üò§ Stress & Overwhelm</div><div class="resource-desc">Time management, boundaries, mindful breaks</div></div>
            <div class="resource-card" onclick="bot.showCopingCategory('sleep')"><div class="resource-title">üò¥ Sleep Problems</div><div class="resource-desc">Sleep hygiene, wind-down routine, relaxation</div></div>
            <button class="modal-btn secondary" onclick="closeCopingModal()">Close</button>
        </div>
    </div>
    <div class="modal-overlay" id="resourcesModal">
        <div class="modal">
            <div class="modal-header"><div class="modal-icon">üìö</div><h2 class="modal-title">Professional Help</h2><p class="modal-subtitle">Connect with verified mental health professionals</p></div>
            <div class="resource-card" onclick="window.open('https://www.practo.com/counselling', '_blank')"><div class="resource-title">üè• Practo Counseling</div><div class="resource-desc">Find therapists, psychiatrists, counselors near you</div></div>
            <div class="resource-card" onclick="window.open('https://www.talktoangel.com', '_blank')"><div class="resource-title">üí¨ TalktoAngel</div><div class="resource-desc">Online therapy & counseling platform</div></div>
            <div class="resource-card" onclick="window.open('https://www.nimhans.ac.in', '_blank')"><div class="resource-title">üèõÔ∏è NIMHANS</div><div class="resource-desc">National Institute of Mental Health</div></div>
            <button class="modal-btn secondary" onclick="closeResourcesModal()">Close</button>
        </div>
    </div>

    <!-- FLOATING AI TOGGLE BUTTON (Bottom-Right) -->
    <button class="floating-ai-toggle" id="floatingAiToggle" onclick="bot.toggleAI()" title="AI Mode: ON ‚ú®">
        ü§ñ
        <span class="ai-status-badge" id="aiStatusBadge"></span>
    </button>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="bot-info">
                    <div class="bot-avatar-header" id="botAvatar">üßò</div>
                    <div class="bot-details">
                        <h1 id="botName">CalmCompanion</h1>
                        <div class="bot-status">
                            <span class="status-dot"></span>
                            <span id="statusText">Online ‚Ä¢ Ready to listen</span>
                        </div>
                        <div style="font-size:12px; color:var(--text-secondary);" id="userInfoLine"></div>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="icon-btn journey-btn" onclick="goToJourney()" title="Back to Journey">üè°</button>
                    <button class="icon-btn peer-btn" onclick="bot.openPeerChat()" title="Talk to a Peer">üë•</button>
                    <button class="icon-btn" onclick="bot.showToolsMenu()" title="Mental Health Tools">üõ†Ô∏è</button>
                    <button class="icon-btn" onclick="bot.showVoiceSettings()" title="Voice Settings">üéôÔ∏è</button>
                    <button class="icon-btn" onclick="bot.showPersonality()" title="Bot Personality">ü§ñ</button>
                    <button class="icon-btn" onclick="bot.showEmergencyContacts()" title="Emergency Contacts">üö®</button>
                    <button class="icon-btn" onclick="bot.showAchievements()" title="Achievements">üèÜ</button>
                    <button class="icon-btn active" id="voiceToggle" onclick="bot.toggleVoice()" title="Voice Output">üîä</button>
                    <button class="icon-btn active" id="soundToggle" onclick="bot.toggleSounds()" title="Notification Sounds">üîî</button>
                    <button class="icon-btn" onclick="bot.showHistory()" title="Chat History">üìú</button>
                    <button class="icon-btn" id="themeToggle" onclick="bot.toggleTheme()" title="Dark Mode">üåô</button>
                    <button class="icon-btn" onclick="bot.showHelp()" title="Help">‚ùì</button>
                    <button class="icon-btn" onclick="bot.clearChat()" title="Clear Chat">üóëÔ∏è</button>
                </div>
            </div>
        </div>

        <div class="analytics-bar">
            <div class="mood-stat">
                Total Chats <span id="totalChats">0</span>
            </div>
            <div class="mood-stat">
                Messages Today <span id="todayMessages">0</span>
            </div>
            <div class="mood-stat">
                Current Mood <span id="currentMood">Neutral</span>
            </div>
            <div class="mood-stat">
                Streak <span id="streakDays">0</span> days üî•
            </div>
            <button class="mood-chart-btn" onclick="bot.showAnalytics()">üìä View Mood Trends</button>
        </div>

        <div class="chat-container">
            <div class="chat-messages" id="chatMessages"></div>

            <div class="chat-input-area">
                <div class="input-wrapper">
                    <textarea class="chat-input" id="userInput" placeholder="Type how you're feeling..." rows="1"></textarea>
                    <div class="btn-group">
                        <button class="send-btn" onclick="bot.handleSend()">Send</button>
                        <button class="voice-btn" id="voiceBtn" onclick="bot.toggleVoiceInput()">üé§ Speak</button>
                    </div>
                </div>

                <div style="margin-top:10px; display:flex; flex-wrap:wrap; gap:6px; font-size:12px;">
                    <button class="chip-btn" data-text="I'm feeling very anxious and I don't know why.">I'm anxious</button>
                    <button class="chip-btn" data-text="I need help coping with my thoughts.">I need help</button>
                    <button class="chip-btn" data-text="I can't sleep and my mind is racing.">Can't sleep</button>
                    <button class="chip-btn" onclick="bot.showDailyAffirmation()">‚ú® Daily Affirmation</button>
                </div>

                <div id="typingIndicator" class="typing-indicator" style="margin-top:10px;">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>

            <div style="padding:10px 16px; font-size:11px; color:var(--text-secondary); display:flex; align-items:center; gap:8px; border-top:1px solid var(--border-color); background:var(--bg-card);">
                <span>Rate this chat:</span>
                <button id="thumbUp" class="chip-btn">üëç</button>
                <button id="thumbDown" class="chip-btn">üëé</button>
                <span style="margin-left: auto;">Emotion Intensity: <span id="emotionIntensity">5</span>/10</span>
            </div>
        </div>
    </div>

    <script>
        // Utility Functions
        function closeVoiceSettings() {
            document.getElementById('voiceSettingsModal').classList.remove('active');
        }

        function closePersonalityModal() {
            document.getElementById('personalityModal').classList.remove('active');
        }

        function closeEmergencyModal() {
            document.getElementById('emergencyModal').classList.remove('active');
        }

        function closeAchievementsModal() {
            document.getElementById('achievementsModal').classList.remove('active');
        }

        function closeAffirmationModal() {
            document.getElementById('affirmationModal').classList.remove('active');
        }

        function goToJourney() {
            if (confirm('Go back to Journey page?')) {
                window.location.href = 'journey.html';
            }

        function closeHistoryModal(){ document.getElementById('historyModal').classList.remove('active'); }
        function closeAnalyticsModal(){ document.getElementById('analyticsModal').classList.remove('active'); }
        function closeBreathingModal(){ document.getElementById('breathingModal').classList.remove('active'); }
        function closeMeditationModal(){ document.getElementById('meditationModal').classList.remove('active'); }
        function closeGroundingModal(){ document.getElementById('groundingModal').classList.remove('active'); }
        function closePHQ9Modal(){ document.getElementById('phq9Modal').classList.remove('active'); }
        function closeGAD7Modal(){ document.getElementById('gad7Modal').classList.remove('active'); }
        function closeCopingModal(){ document.getElementById('copingModal').classList.remove('active'); }
        function closeResourcesModal(){ document.getElementById('resourcesModal').classList.remove('active'); }

        }

        class CalmCompanionBot {
            constructor() {
                // NEW: Try to get username from journey.html localStorage
                this.nameKey = 'calmcompanion_name';
                this.journeyName = localStorage.getItem('journey_username') || localStorage.getItem('userName') || '';
                this.userName = localStorage.getItem(this.nameKey) || this.journeyName;
                
                this.voiceEnabled = true;
                this.soundsEnabled = true;
                this.synthesis = window.speechSynthesis;
                this.voices = [];
                this.selectedVoice = null;
                this.speechRate = 1.0;
                this.speechPitch = 1.0;
                this.recognition = null;
                this.isRecording = false;
                this.chatHistory = this.loadChatHistory();
                this.moodData = this.loadMoodData();
                this.sentimentScores = { positive: 0, neutral: 0, negative: 0 };
                this.conversationContext = [];
                this.breathingInterval = null;
                this.emotionIntensity = 5;
                this.personality = localStorage.getItem('bot_personality') || 'empathetic';
                this.achievements = this.loadAchievements();
                this.sessionStartTime = Date.now();

                // NEW: Daily affirmations
                this.affirmations = [
                    "You are stronger than you think. Every step forward matters.",
                    "Your feelings are valid, and it's okay to not be okay sometimes.",
                    "Taking care of your mental health is a sign of strength, not weakness.",
                    "You deserve compassion, especially from yourself.",
                    "Progress isn't linear - healing takes time, and that's okay.",
                    "You are worthy of love, support, and happiness.",
                    "Small steps still move you forward. Be proud of yourself.",
                    "Your story matters. Your experiences matter. You matter.",
                    "It's okay to ask for help. That takes courage.",
                    "You've survived 100% of your worst days. You're doing great."
                ];

                this.crisisKeywords = [
                    'suicide', 'kill myself', 'end my life', 'want to die', 'want die',
                    'no reason to live', 'better off dead', 'harm myself', 'hurt myself',
                    'cut myself', 'end it all', '‡§Ü‡§§‡•ç‡§Æ‡§π‡§§‡•ç‡§Ø‡§æ', '‡§Æ‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡§æ', '‡§ú‡•Ä‡§®‡§æ ‡§®‡§π‡•Ä‡§Ç',
                    '‡§Æ‡§∞ ‡§ú‡§æ‡§ä‡§Ç', '‡§ú‡§º‡§ø‡§Ç‡§¶‡§ó‡•Ä ‡§∏‡•á'
                ];

                this.mentalHealthKeywords = {
                    anxiety: ['anxious', 'anxiety', 'worried', 'panic', 'nervous', 'scared', 'fear', 'overwhelmed', 'cant breathe', 'heart racing', 'restless'],
                    depression: ['depressed', 'depression', 'sad', 'hopeless', 'worthless', 'empty', 'numb', 'no motivation', 'tired', 'crying', 'lost interest'],
                    stress: ['stressed', 'stress', 'pressure', 'burnout', 'exhausted', 'overwhelmed', 'too much', 'cant cope', 'breaking point'],
                    sleep: ['cant sleep', 'insomnia', 'nightmares', 'tired', 'fatigue', 'no energy', 'sleep problems'],
                    loneliness: ['lonely', 'alone', 'isolated', 'no friends', 'nobody cares', 'disconnected'],
                    therapy: ['therapy', 'therapist', 'counseling', 'need help', 'professional help'],
                    coping: ['coping', 'cope', 'manage', 'deal with', 'strategies', 'breathing', 'meditation']
                };

                this.phq9Questions = ["Little interest or pleasure in doing things","Feeling down, depressed, or hopeless","Trouble falling/staying asleep, or sleeping too much","Feeling tired or having little energy","Poor appetite or overeating","Feeling bad about yourself ‚Äî or that you are a failure","Trouble concentrating on things","Moving/speaking slowly or being very restless","Thoughts that you'd be better off dead or hurting yourself"];
                this.gad7Questions = ["Feeling nervous, anxious, or on edge","Not being able to stop or control worrying","Worrying too much about different things","Trouble relaxing","Being so restless that it is hard to sit still","Becoming easily annoyed or irritable","Feeling afraid as if something awful might happen"];

                this.geminiApiKey = 'AIzaSyDeDy9rvw825y6pVqSZxj_rwt-32v799M8';
                this.geminiEndpoint = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent';
                this.useAI = true;
                this.aiConversationHistory = [];
                this.maxHistoryLength = 10;
                this.systemPrompt = `You are CalmCompanion, an empathetic mental health support AI. Be warm, compassionate, and personal. Keep responses concise (2-4 sentences). Validate emotions, provide evidence-based support, suggest specific tools (breathing, grounding, meditation, assessments, coping), never diagnose. If crisis keywords detected, urgently encourage emergency contacts. Recognize Indian context (academic stress, family pressure, career anxiety). Use user's name when available. Add supportive emojis occasionally (üíú, üå∏, ‚ú®).`;


                this.theme = localStorage.getItem('calmcompanion_theme') || 'default';
                
                // NEW: Check online status
                this.checkOnlineStatus();
                window.addEventListener('online', () => this.updateOnlineStatus(true));
                window.addEventListener('offline', () => this.updateOnlineStatus(false));

                this.init();
            }

            checkOnlineStatus() {
                this.updateOnlineStatus(navigator.onLine);
            }

            updateOnlineStatus(isOnline) {
                const banner = document.getElementById('offlineBanner');
                if (!isOnline) {
                    banner.classList.add('active');
                } else {
                    banner.classList.remove('active');
                }
            }

            loadChatHistory() {
                try {
                    return JSON.parse(localStorage.getItem('chathistory')) || [];
                } catch(e) {
                    return [];
                }
            }

            saveChatHistory() {
                if (this.chatHistory.length > 100) {
                    this.chatHistory = this.chatHistory.slice(-100);
                }
                localStorage.setItem('chathistory', JSON.stringify(this.chatHistory));
            }

            loadMoodData() {
                try {
                    return JSON.parse(localStorage.getItem('mooddata')) || {};
                } catch(e) {
                    return {};
                }
            }

            saveMoodData() {
                localStorage.setItem('mooddata', JSON.stringify(this.moodData));
            }

            loadAchievements() {
                try {
                    return JSON.parse(localStorage.getItem('achievements')) || {
                        firstChat: false,
                        tenChats: false,
                        weekStreak: false,
                        tookAssessment: false,
                        usedBreathing: false,
                        exportedChat: false
                    };
                } catch(e) {
                    return {};
                }
            }

            saveAchievements() {
                localStorage.setItem('achievements', JSON.stringify(this.achievements));
            }

            // NEW: Load available voices
            loadVoices() {
                this.voices = this.synthesis.getVoices();
                const select = document.getElementById('voiceSelect');
                if (select) {
                    select.innerHTML = '';
                    this.voices.forEach((voice, i) => {
                        const option = document.createElement('option');
                        option.value = i;
                        option.textContent = `${voice.name} (${voice.lang})`;
                        select.appendChild(option);
                    });
                    
                    // Set default voice (prefer English)
                    const englishVoice = this.voices.findIndex(v => v.lang.startsWith('en'));
                    if (englishVoice >= 0) {
                        select.value = englishVoice;
                        this.selectedVoice = this.voices[englishVoice];
                    }
                }
            }

            init() {
                this.applyTheme(this.theme);
                this.updateHeaderName();
                this.setupListeners();
                this.updateAnalyticsBars();
                this.loadVoices();
                
                // Load voices when they're ready
                if (this.synthesis.onvoiceschanged !== undefined) {
                    this.synthesis.onvoiceschanged = () => this.loadVoices();
                }

                // Check for username from journey
                if (!this.userName && this.journeyName) {
                    this.userName = this.journeyName;
                    localStorage.setItem(this.nameKey, this.journeyName);
                }

                if (this.userName) {
                    this.startChat();
                    this.checkAchievements();
                } else {
                    // Show welcome without forcing name input
                    this.startChat();
                }

                // Calculate streak
                this.calculateStreak();
            }

            calculateStreak() {
                const dates = Object.keys(this.moodData).sort();
                if (dates.length === 0) {
                    document.getElementById('streakDays').textContent = '0';
                    return;
                }

                let streak = 1;
                const today = new Date().toISOString().split('T')[0];
                
                for (let i = dates.length - 1; i > 0; i--) {
                    const current = new Date(dates[i]);
                    const previous = new Date(dates[i - 1]);
                    const diffDays = Math.floor((current - previous) / (1000 * 60 * 60 * 24));
                    
                    if (diffDays === 1) {
                        streak++;
                    } else {
                        break;
                    }
                }

                document.getElementById('streakDays').textContent = streak;
                
                if (streak >= 7 && !this.achievements.weekStreak) {
                    this.unlockAchievement('weekStreak', 'üî• 7-Day Streak!', 'You\'ve checked in for 7 days straight!');
                }
            }

            unlockAchievement(key, title, desc) {
                if (this.achievements[key]) return;
                
                this.achievements[key] = true;
                this.saveAchievements();
                
                this.addMessage(`üèÜ Achievement Unlocked: ${title}\n${desc}`, false);
                this.playNotificationSound();
            }

            checkAchievements() {
                if (this.chatHistory.length >= 1 && !this.achievements.firstChat) {
                    this.unlockAchievement('firstChat', 'üëã First Chat!', 'You started your mental health journey!');
                }
                if (this.chatHistory.length >= 10 && !this.achievements.tenChats) {
                    this.unlockAchievement('tenChats', 'üí¨ Talkative!', 'You\'ve had 10 conversations with me!');
                }
            }

            showAchievements() {
                const list = document.getElementById('achievementsList');
                list.innerHTML = '';
                
                const allAchievements = [
                    { key: 'firstChat', emoji: 'üëã', title: 'First Chat', desc: 'Started your journey' },
                    { key: 'tenChats', emoji: 'üí¨', title: 'Talkative', desc: '10 conversations' },
                    { key: 'weekStreak', emoji: 'üî•', title: '7-Day Streak', desc: 'Checked in for 7 days' },
                    { key: 'tookAssessment', emoji: 'üìã', title: 'Self-Aware', desc: 'Completed an assessment' },
                    { key: 'usedBreathing', emoji: 'üå¨Ô∏è', title: 'Calm Mind', desc: 'Used breathing exercise' },
                    { key: 'exportedChat', emoji: 'üì•', title: 'Organized', desc: 'Exported chat history' }
                ];

                allAchievements.forEach(ach => {
                    const unlocked = this.achievements[ach.key];
                    const div = document.createElement('div');
                    div.className = 'resource-card';
                    div.style.opacity = unlocked ? '1' : '0.5';
                    div.innerHTML = `
                        <div class="resource-title">${ach.emoji} ${ach.title} ${unlocked ? '‚úì' : 'üîí'}</div>
                        <div class="resource-desc">${ach.desc}</div>
                    `;
                    list.appendChild(div);
                });

                document.getElementById('achievementsModal').classList.add('active');
            }

            setupListeners() {
                const input = document.getElementById('userInput');
                input.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.handleSend();
                    }
                });

                input.addEventListener('input', () => {
                    input.style.height = 'auto';
                    input.style.height = Math.min(input.scrollHeight, 120) + 'px';
                });

                document.querySelectorAll('.chip-btn[data-text]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        input.value = btn.dataset.text;
                        input.focus();
                    });
                });

                const up = document.getElementById('thumbUp');
                const down = document.getElementById('thumbDown');
                if (up && down) {
                    up.addEventListener('click', () => this.rateChat('up'));
                    down.addEventListener('click', () => this.rateChat('down'));
                }

                // Voice settings sliders
                const rateSlider = document.getElementById('rateSlider');
                const pitchSlider = document.getElementById('pitchSlider');
                
                if (rateSlider) {
                    rateSlider.addEventListener('input', (e) => {
                        this.speechRate = parseFloat(e.target.value);
                        document.getElementById('rateValue').textContent = this.speechRate.toFixed(1);
                    });
                }

                if (pitchSlider) {
                    pitchSlider.addEventListener('input', (e) => {
                        this.speechPitch = parseFloat(e.target.value);
                        document.getElementById('pitchValue').textContent = this.speechPitch.toFixed(1);
                    });
                }

                const voiceSelect = document.getElementById('voiceSelect');
                if (voiceSelect) {
                    voiceSelect.addEventListener('change', (e) => {
                        this.selectedVoice = this.voices[e.target.value];
                    });
                }
            }

            updateHeaderName() {
                const info = document.getElementById('userInfoLine');
                if (info && this.userName) {
                    info.textContent = `Talking with ${this.userName}`;
                }
            }

            applyTheme(theme) {
                document.body.className = '';
                if (theme === 'dark') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
                } else {
                    document.getElementById('themeToggle').textContent = 'üåô';
                }
            }

            toggleTheme() {
                if (document.body.classList.contains('dark-mode')) {
                    this.theme = 'default';
                } else {
                    this.theme = 'dark';
                }
                this.applyTheme(this.theme);
                try {
                    localStorage.setItem('calmcompanion_theme', this.theme);
                } catch (e) {}
            }

            startChat() {
                const name = this.userName || 'friend';
                const greetings = [
                    `Hi ${name}! How are you feeling today?`,
                    `Welcome back ${name}! What's on your mind?`,
                    `Hey ${name}! I'm here to listen.`
                ];
                const greeting = greetings[Math.floor(Math.random() * greetings.length)];
                this.addMessage(greeting, false);

                setTimeout(() => {
                    const features = `Here's what I can help you with:\n\n‚Ä¢ AI emotional support chat\n‚Ä¢ Anonymous peer chat (üë• button)\n‚Ä¢ Breathing & relaxation exercises\n‚Ä¢ Guided meditation sessions\n‚Ä¢ Grounding techniques (5-4-3-2-1)\n‚Ä¢ Mental health assessments (PHQ-9, GAD-7)\n‚Ä¢ Coping strategies library\n‚Ä¢ Professional therapist resources\n‚Ä¢ Mood tracking & analytics\n‚Ä¢ Daily affirmations\n‚Ä¢ Emergency contacts\n\nJust tell me how you're feeling and we'll start there.`;
                    this.addMessage(features, false);
                }, 1500);

                if (this.voiceEnabled) {
                    this.speak(greeting);
                }

                if (this.chatHistory.length) {
                    this.chatHistory.slice(-10).forEach(msg => {
                        if (msg.type === 'user') {
                            this.addMessage(msg.user, true);
                        } else {
                            this.addMessage(msg.bot, false, false, msg.sentiment);
                        }
                    });
                }
            }

            // NEW: Voice Settings
            showVoiceSettings() {
                document.getElementById('voiceSettingsModal').classList.add('active');
            }

            testVoice() {
                this.speak("Hello! This is how I sound with your current settings.");
            }

            // NEW: Bot Personality
            showPersonality() {
                document.getElementById('personalityModal').classList.add('active');
            }

            setPersonality(type) {
                this.personality = type;
                localStorage.setItem('bot_personality', type);
                closePersonalityModal();
                
                const messages = {
                    empathetic: "I'll be more empathetic and gentle with you. üíú",
                    motivational: "Let's do this! I'll help keep you motivated! üí™",
                    clinical: "I'll use evidence-based approaches and structured support. ü©∫"
                };
                this.addMessage(messages[type], false);
            }

            // NEW: Emergency Contacts
            showEmergencyContacts() {
                document.getElementById('emergencyModal').classList.add('active');
            }

            // NEW: Daily Affirmation
            showDailyAffirmation() {
                const affirmation = this.affirmations[Math.floor(Math.random() * this.affirmations.length)];
                document.getElementById('affirmationText').textContent = affirmation;
                document.getElementById('affirmationModal').classList.add('active');
            }

            getNewAffirmation() {
                this.showDailyAffirmation();
            }

            showToolsMenu() {
                const tools = `üõ†Ô∏è Mental Health Tools:\n\n‚Ä¢ Type "breathing" for breathing exercises\n‚Ä¢ Type "meditation" for guided sessions\n‚Ä¢ Type "grounding" for 5-4-3-2-1 technique\n‚Ä¢ Type "assessment" for depression/anxiety screening\n‚Ä¢ Type "coping" for coping strategies library\n‚Ä¢ Type "resources" for therapist directories\n‚Ä¢ Click üö® for emergency contacts\n‚Ä¢ Click üèÜ to see your achievements\n\nOr use the toolbar buttons!`;
                this.addMessage(tools, false);
            }

            openPeerChat() {
                const url = `peerchat.html?name=${encodeURIComponent(this.userName || 'friend')}`;
                window.location.href = url;
            }

            toggleVoice() {
                this.voiceEnabled = !this.voiceEnabled;
                const btn = document.getElementById('voiceToggle');
                if (this.voiceEnabled) {
                    btn.classList.add('active');
                    btn.title = 'Voice Output';
                } else {
                    btn.classList.remove('active');
                    btn.title = 'Voice muted';
                }
            }

            toggleSounds() {
                this.soundsEnabled = !this.soundsEnabled;
                const btn = document.getElementById('soundToggle');
                if (this.soundsEnabled) {
                    btn.classList.add('active');
                    btn.title = 'Notification Sounds';
                } else {
                    btn.classList.remove('active');
                    btn.title = 'Sounds muted';
                }
            }

            showHistory() {
                const list = document.getElementById('historyList');
                list.innerHTML = '';
                if (!this.chatHistory.length) {
                    list.innerHTML = '<div class="history-item">No history yet.</div>';
                } else {
                    this.chatHistory.forEach(msg => {
                        const div = document.createElement('div');
                        div.className = 'history-item';
                        const date = new Date(msg.timestamp).toLocaleString();
                        const preview = msg.type === 'user' ? msg.user : msg.bot;
                        div.innerHTML = `
                            <div class="history-date">${date}</div>
                            <div class="history-preview">${preview}</div>
                        `;
                        list.appendChild(div);
                    });
                }
                document.getElementById('historyModal').classList.add('active');
            }

            showAnalytics() {
                const chart = document.getElementById('moodChart');
                chart.innerHTML = '';
                const summaryEl = document.getElementById('weekSummary');

                const today = new Date();
                const days = [];
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    const key = d.toISOString().split('T')[0];
                    days.push({ key, label: d.toLocaleDateString('en-IN', { weekday: 'short' }) });
                }

                let totalPos = 0, totalNeg = 0, totalNeu = 0;

                days.forEach(day => {
                    const data = this.moodData[day.key] || { positive:0, neutral:0, negative:0 };
                    const total = data.positive + data.neutral + data.negative || 1;
                    totalPos += data.positive;
                    totalNeg += data.negative;
                    totalNeu += data.neutral;

                    const bar = document.createElement('div');
                    bar.className = 'chart-bar';
                    bar.style.height = (50 + total * 10) + 'px';
                    bar.title = `${day.label}: +${data.positive} / ~${data.neutral} / -${data.negative}`;
                    chart.appendChild(bar);
                });

                summaryEl.textContent = `Positive: ${totalPos}  ‚Ä¢  Neutral: ${totalNeu}  ‚Ä¢  Negative: ${totalNeg}. This is just reflection data, not a diagnosis.`;
                document.getElementById('analyticsModal').classList.add('active');
            }

            showHelp() {
                const helpText = `Tips for using CalmCompanion:\n\n‚Ä¢ I can understand natural language\n‚Ä¢ I remember context from our conversation\n‚Ä¢ Use üõ†Ô∏è for mental health tools\n‚Ä¢ Use üéôÔ∏è to customize my voice\n‚Ä¢ Use ü§ñ to change my personality\n‚Ä¢ Use üö® for emergency contacts\n‚Ä¢ Use üèÜ to see achievements\n‚Ä¢ Type keywords: breathing, meditation, grounding, assessment, coping, resources\n‚Ä¢ Your data stays private on your device\n‚Ä¢ Click ‚ú® Daily Affirmation for inspiration`;
                this.addMessage(helpText, false);
            }

            clearChat() {
                if (!confirm('Clear this conversation?')) return;
                this.chatHistory = [];
                this.conversationContext = [];
                this.saveChatHistory();
                const chatContainer = document.getElementById('chatMessages');
                if (chatContainer) chatContainer.innerHTML = '';
            }

            async handleSend() {
                const input = document.getElementById('userInput');
                const text = input.value.trim();
                if (!text) return;

                this.addMessage(text, true);
                this.chatHistory.push({ timestamp: Date.now(), user: text, type: 'user' });
                this.conversationContext.push({ role: 'user', text: text });

                input.value = '';
                input.style.height = 'auto';

                // NEW: Detect emotion intensity
                this.emotionIntensity = this.detectEmotionIntensity(text);
                document.getElementById('emotionIntensity').textContent = this.emotionIntensity;

                this.showTyping();
                setTimeout(() => this.hideTyping(), 1500);

                setTimeout(async () => {
                    const reply = await this.generateReply(text);
                    const isCrisis = this.detectCrisis(text);
                    const sentiment = this.analyzeSentiment(text);

                    this.addMessage(reply, false, isCrisis, sentiment);
                    this.chatHistory.push({ timestamp: Date.now(), bot: reply, type: 'bot', sentiment: sentiment });
                    this.conversationContext.push({ role: 'bot', text: reply });

                    // NEW: Add suggested follow-up questions
                    this.addSuggestedReplies(text);

                    if (this.conversationContext.length > 20) {
                        this.conversationContext = this.conversationContext.slice(-20);
                    }

                    this.saveChatHistory();
                    this.updateMoodData(sentiment);
                    this.updateAnalyticsBars();
                    this.checkAchievements();

                    if (this.voiceEnabled && !isCrisis) {
                        this.speak(reply);
                    }
                    if (this.soundsEnabled) {
                        this.playNotificationSound();
                    }
                    if (isCrisis) {
                        const sosModal = document.getElementById('sosModal');
                        if (sosModal) sosModal.classList.add('active');
                    }
                }, 1500 + Math.random() * 1000);
            }

            // NEW: Detect emotion intensity on 0-10 scale
            detectEmotionIntensity(text) {
                const lowerText = text.toLowerCase();
                let intensity = 5; // neutral

                // High intensity words
                const highWords = ['extremely', 'completely', 'absolutely', 'totally', 'really really', 'so much', 'unbearable', 'overwhelming', 'terrible', 'horrible', 'worst', 'cant take'];
                // Low intensity words
                const lowWords = ['slightly', 'a bit', 'somewhat', 'a little', 'kind of', 'maybe', 'possibly'];

                const highCount = highWords.filter(w => lowerText.includes(w)).length;
                const lowCount = lowWords.filter(w => lowerText.includes(w)).length;

                if (highCount > 0) intensity = Math.min(10, 5 + highCount * 2);
                if (lowCount > 0) intensity = Math.max(1, 5 - lowCount * 2);

                // Check for crisis keywords
                if (this.detectCrisis(text)) intensity = 10;

                return intensity;
            }

            // NEW: Add suggested follow-up questions
            addSuggestedReplies(userText) {
                const suggestions = {
                    anxiety: ['Can you guide me through breathing?', 'What grounding techniques help?', 'Should I try meditation?'],
                    depression: ['How can I feel better?', 'Can I take an assessment?', 'What coping strategies help?'],
                    stress: ['How do I manage stress?', 'Can meditation help?', 'What should I do first?'],
                    therapy: ['How do I find a therapist?', 'What types of therapy exist?', 'Is therapy expensive?']
                };

                let category = null;
                for (const [cat, keywords] of Object.entries(this.mentalHealthKeywords)) {
                    if (keywords.some(k => userText.toLowerCase().includes(k))) {
                        category = cat;
                        break;
                    }
                }

                if (category && suggestions[category]) {
                    const container = document.createElement('div');
                    container.className = 'message bot';
                    container.innerHTML = `
                        <div class="message-avatar">üí°</div>
                        <div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">Suggested questions:</div>
                            <div class="suggested-replies">
                                ${suggestions[category].map(s => `<button class="suggested-reply-btn" onclick="bot.askSuggested('${s}')">${s}</button>`).join('')}
                            </div>
                        </div>
                    `;
                    document.getElementById('chatMessages').appendChild(container);
                    this.scrollToBottom();
                }
            }

            askSuggested(question) {
                document.getElementById('userInput').value = question;
                this.handleSend();
            }

            detectCrisis(text) {
                const lower = text.toLowerCase();
                return this.crisisKeywords.some(k => lower.includes(k.toLowerCase()));
            }

            analyzeSentiment(text) {
                const lower = text.toLowerCase();
                const positiveWords = ['happy', 'good', 'great', 'better', 'excited', 'love', 'thanks', 'grateful', 'wonderful', 'amazing', 'üòä', 'üôÇ'];
                const positiveCount = positiveWords.filter(w => lower.includes(w)).length;
                const negativeWords = ['sad', 'bad', 'worse', 'angry', 'hate', 'terrible', 'awful', 'depressed', 'anxious', 'stressed', 'üò¢', 'üò∞'];
                const negativeCount = negativeWords.filter(w => lower.includes(w)).length;

                if (positiveCount > negativeCount) {
                    this.sentimentScores.positive++;
                    return { type: 'positive', emoji: 'üòä', label: 'Positive' };
                } else if (negativeCount > positiveCount) {
                    this.sentimentScores.negative++;
                    return { type: 'negative', emoji: 'üò¢', label: 'Negative' };
                } else {
                    this.sentimentScores.neutral++;
                    return { type: 'neutral', emoji: 'üòê', label: 'Neutral' };
                }
            }

            updateMoodData(sentiment) {
                const today = new Date().toISOString().split('T')[0];
                if (!this.moodData[today]) {
                    this.moodData[today] = { positive: 0, neutral: 0, negative: 0 };
                }
                this.moodData[today][sentiment.type]++;
                this.saveMoodData();
                document.getElementById('currentMood').textContent = `${sentiment.label} ${sentiment.emoji}`;
            }

            updateAnalyticsBars() {
                const dates = Object.keys(this.moodData);
                document.getElementById('totalChats').textContent = dates.length;

                const today = new Date().toISOString().split('T')[0];
                const todayData = this.moodData[today] || { positive: 0, neutral: 0, negative: 0 };
                const todayTotal = todayData.positive + todayData.neutral + todayData.negative;
                document.getElementById('todayMessages').textContent = todayTotal;
            }

            addMessage(text, isUser = false, isCrisis = false, sentiment = null) {
                const chat = document.getElementById('chatMessages');
                const wrapper = document.createElement('div');
                wrapper.className = 'message ' + (isUser ? 'user' : 'bot');

                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = isUser
                    ? ((this.userName || 'U').charAt(0).toUpperCase())
                    : 'üßò';

                const content = document.createElement('div');
                content.className = 'message-content';
                if (isCrisis && !isUser) {
                    content.classList.add('crisis-alert');
                }
                content.textContent = text;

                const bubble = document.createElement('div');
                bubble.appendChild(content);

                if (!isUser && sentiment) {
                    const meta = document.createElement('div');
                    meta.className = 'message-sentiment';
                    meta.textContent = `Tone: ${sentiment.label} ${sentiment.emoji}`;
                    bubble.appendChild(meta);
                }

                wrapper.appendChild(avatar);
                wrapper.appendChild(bubble);
                chat.appendChild(wrapper);
                this.scrollToBottom();
            }

            scrollToBottom() {
                const chat = document.getElementById('chatMessages');
                chat.scrollTop = chat.scrollHeight;
            }

            showTyping() {
                const el = document.getElementById('typingIndicator');
                if (el) el.classList.add('active');
            }

            hideTyping() {
                const el = document.getElementById('typingIndicator');
                if (el) el.classList.remove('active');
            }

            // NEW: Enhanced speak with voice settings
            speak(text) {
                if (!this.synthesis) return;
                this.synthesis.cancel();
                const utter = new SpeechSynthesisUtterance(text);
                
                if (this.selectedVoice) {
                    utter.voice = this.selectedVoice;
                }
                utter.rate = this.speechRate;
                utter.pitch = this.speechPitch;
                
                this.synthesis.speak(utter);
            }

            playNotificationSound() {
                try {
                    const ctx = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.value = 880;
                    osc.connect(gain);
                    gain.connect(ctx.destination);
                    gain.gain.setValueAtTime(0.0001, ctx.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.1, ctx.currentTime + 0.01);
                    gain.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.2);
                    osc.start();
                    osc.stop(ctx.currentTime + 0.25);
                } catch(e) {}
            }

            toggleVoiceInput() {
                if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
                    alert('Voice input not supported in this browser.');
                    return;
                }
                const btn = document.getElementById('voiceBtn');
                if (!this.recognition) {
                    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SR();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'en-US';

                    this.recognition.onresult = (e) => {
                        const transcript = e.results[0][0].transcript;
                        const input = document.getElementById('userInput');
                        input.value = (input.value ? input.value + ' ' : '') + transcript;
                        input.focus();
                        btn.classList.remove('recording');
                        this.isRecording = false;
                    };
                    this.recognition.onerror = () => {
                        btn.classList.remove('recording');
                        this.isRecording = false;
                    };
                }

                if (this.isRecording) {
                    this.recognition.stop();
                    btn.classList.remove('recording');
                    this.isRecording = false;
                } else {
                    this.recognition.start();
                    btn.classList.add('recording');
                    this.isRecording = true;
                }
            }

            exportHistory() {
                const data = {
                    name: this.userName,
                    history: this.chatHistory,
                    moodData: this.moodData,
                    achievements: this.achievements
                };
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `calmcompanion-history-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                if (!this.achievements.exportedChat) {
                    this.unlockAchievement('exportedChat', 'üì• Organized!', 'You exported your chat history!');
                }
            }

            exportHistoryText() {
                if (!this.chatHistory.length) {
                    this.addMessage('No chat to export yet.', false);
                    return;
                }
                let text = 'CalmCompanion Chat History\n\n';
                this.chatHistory.forEach(msg => {
                    const time = new Date(msg.timestamp).toLocaleString();
                    if (msg.type === 'user') {
                        text += `[You ‚Ä¢ ${time}]: ${msg.user}\n`;
                    } else {
                        text += `[Bot ‚Ä¢ ${time}]: ${msg.bot}\n`;
                    }
                });
                const blob = new Blob([text], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `calmcompanion-chat-${new Date().toISOString().split('T')[0]}.txt`;
                a.click();
                URL.revokeObjectURL(url);
                this.addMessage('Chat exported as text file.', false);
            }

            rateChat(type) {
                const key = 'calmcompanion_ratings';
                let data;
                try {
                    data = JSON.parse(localStorage.getItem(key)) || { up:0, down:0 };
                } catch(e) {
                    data = { up:0, down:0 };
                }
                if (type === 'up') data.up++; else data.down++;
                localStorage.setItem(key, JSON.stringify(data));
                this.addMessage('Thank you for your feedback. üíô', false);
            }



            async generateAIResponse(userMessage) {
                try {
                    const name = this.userName || "friend";
                    this.aiConversationHistory.push({ role: "user", parts: [{ text: userMessage }] });
                    if (this.aiConversationHistory.length > this.maxHistoryLength * 2) {
                        this.aiConversationHistory = this.aiConversationHistory.slice(-this.maxHistoryLength * 2);
                    }
                    const requestBody = {
                        contents: [{ role: "user", parts: [{ text: this.systemPrompt + "\n\nUser's name: " + name }] }, ...this.aiConversationHistory],
                        generationConfig: { temperature: 0.7, topK: 40, topP: 0.95, maxOutputTokens: 200 },
                        safetySettings: [
                            { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_NONE" },
                            { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
                        ]
                    };
                    const response = await fetch(this.geminiEndpoint + '?key=' + this.geminiApiKey, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('API Error:', errorData);
                        throw new Error('API request failed');
                    }
                    const data = await response.json();
                    if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                        throw new Error('Invalid API response');
                    }
                    const aiReply = data.candidates[0].content.parts[0].text.trim();
                    this.aiConversationHistory.push({ role: "model", parts: [{ text: aiReply }] });
                    return aiReply;
                } catch (error) {
                    console.error('Gemini API Error:', error);
                    return this.getFallbackResponse(userMessage);
                }
            }

            getFallbackResponse(text) {
                const name = this.userName || "friend";
                const responses = [
                    `I hear you, ${name}. That sounds difficult. üíú Would you like to try a breathing exercise?`,
                    `Thank you for sharing, ${name}. Your feelings are valid. üå∏ How can I support you?`,
                    `I'm here for you, ${name}. Would grounding or meditation help?`,
                    `${name}, it takes courage to open up. What would be most helpful right now?`
                ];
                return responses[Math.floor(Math.random() * responses.length)];
            }

            toggleAI() {
                this.useAI = !this.useAI;
                const floatingBtn = document.getElementById('floatingAiToggle');
                const badge = document.getElementById('aiStatusBadge');

                if (floatingBtn) {
                    if (this.useAI) {
                        floatingBtn.classList.remove('ai-off');
                        floatingBtn.title = 'AI Mode: ON ‚ú®';
                        if (badge) badge.classList.remove('off');
                    } else {
                        floatingBtn.classList.add('ai-off');
                        floatingBtn.title = 'AI Mode: OFF';
                        if (badge) badge.classList.add('off');
                    }
                }

                this.addMessage(`ü§ñ AI Mode ${this.useAI ? 'enabled! Smarter responses activated ‚ú®' : 'disabled. Using rule-based responses.'}`, false);
            }

            showBreathingExercise(){ document.getElementById('breathingModal').classList.add('active'); }
            startBreathing(){
                const circle = document.getElementById('breathCircle');
                const instruction = document.getElementById('breathInstruction');
                const btn = document.getElementById('startBreathBtn');
                if (!circle || !instruction || !btn) return;
                btn.disabled = true;
                btn.textContent = "‚óè Running...";
                const phases = [{ label: "Inhale", className: "inhale", ms: 4000 }, { label: "Hold", className: "hold", ms: 7000 }, { label: "Exhale", className: "exhale", ms: 8000 }];
                let phaseIndex = 0;
                const applyPhase = () => {
                    const p = phases[phaseIndex];
                    circle.textContent = p.label;
                    circle.className = "breath-circle " + p.className;
                    instruction.textContent = `${p.label} ‚Ä¢ ${Math.round(p.ms/1000)}s`;
                    phaseIndex = (phaseIndex + 1) % phases.length;
                };
                if (this.breathingInterval) clearInterval(this.breathingInterval);
                applyPhase();
                this.breathingInterval = setInterval(applyPhase, 19000);
            }
            stopBreathing(){
                if (this.breathingInterval) clearInterval(this.breathingInterval);
                this.breathingInterval = null;
                const btn = document.getElementById('startBreathBtn');
                const circle = document.getElementById('breathCircle');
                const instruction = document.getElementById('breathInstruction');
                if (btn){ btn.disabled = false; btn.textContent = "‚ñ∂Ô∏è Start Breathing"; }
                if (circle){ circle.textContent = "Ready"; circle.className = "breath-circle"; }
                if (instruction){ instruction.textContent = "Press Start"; }
                closeBreathingModal();
            }
            showMeditation(){ document.getElementById('meditationModal').classList.add('active'); }
            startMeditation(minutes){
                closeMeditationModal();
                this.addMessage(`üßò‚Äç‚ôÄÔ∏è Starting ${minutes} min meditation. Sit comfortably, close your eyes, focus on your breath.`, false);
                setTimeout(() => {
                    this.addMessage(`‚úÖ Meditation complete! How do you feel now?`, false);
                    if (this.soundsEnabled) this.playNotificationSound();
                }, minutes * 60 * 1000);
            }
            showGrounding(){ document.getElementById('groundingModal').classList.add('active'); }
            completeGrounding(){
                const ids = ["ground5","ground4","ground3","ground2","ground1"];
                const vals = ids.map(id => (document.getElementById(id)?.value || "").trim());
                if (vals.some(v => !v)) { alert("Please fill all 5 fields to complete the grounding exercise."); return; }
                ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ""; });
                closeGroundingModal();
                setTimeout(() => {
                    this.addMessage("üåø Excellent work! Grounding helps reduce panic by anchoring you to the present moment. You did great!", false);
                }, 100);
            }
            showAssessments(){
                this.addMessage("üìã Choose a mental health screening tool:", false);
                setTimeout(() => {
                    const container = document.createElement('div');
                    container.style.cssText = 'display:flex; gap:12px; margin:16px 0; padding:0 48px; flex-wrap:wrap;';
                    container.innerHTML = '<button class="chip-btn" onclick="bot.showPHQ9()">üìä PHQ-9 (Depression)</button><button class="chip-btn" onclick="bot.showGAD7()">üìä GAD-7 (Anxiety)</button>';
                    document.getElementById('chatMessages').appendChild(container);
                    this.scrollToBottom();
                }, 300);
            }
            showPHQ9(){
                const wrap = document.getElementById('phq9Questions');
                wrap.innerHTML = "";
                this.phq9Questions.forEach((q, i) => {
                    const div = document.createElement('div');
                    div.style.marginBottom = "20px";
                    div.innerHTML = `<label class="form-label" style="font-weight:600;">${i+1}. ${q}</label><div class="radio-group"><label class="radio-option"><input type="radio" name="phq9_${i}" value="0"> Not at all</label><label class="radio-option"><input type="radio" name="phq9_${i}" value="1"> Several days</label><label class="radio-option"><input type="radio" name="phq9_${i}" value="2"> More than half the days</label><label class="radio-option"><input type="radio" name="phq9_${i}" value="3"> Nearly every day</label></div>`;
                    wrap.appendChild(div);
                });
                document.getElementById('phq9Modal').classList.add('active');
            }
            calculatePHQ9(){
                let total = 0;
                for (let i=0; i<9; i++){
                    const sel = document.querySelector(`input[name="phq9_${i}"]:checked`);
                    if (!sel){ alert("Please answer all questions to see your results."); return; }
                    total += Number(sel.value);
                }
                let severity = "Minimal";
                if (total >= 5) severity = "Mild";
                if (total >= 10) severity = "Moderate";
                if (total >= 15) severity = "Moderately severe";
                if (total >= 20) severity = "Severe";
                closePHQ9Modal();
                this.addMessage(`üìä PHQ-9 Results:\n\nScore: ${total}/27\nSeverity: ${severity}\n\nThis is a screening tool, not a diagnosis. If you scored moderate or higher, consider reaching out to a professional. Type "resources" for help.`, false);
                if (!this.achievements.tookAssessment){
                    this.unlockAchievement('tookAssessment', 'üìã Self-Aware!', 'Completed screening');
                }
            }
            showGAD7(){
                const wrap = document.getElementById('gad7Questions');
                wrap.innerHTML = "";
                this.gad7Questions.forEach((q, i) => {
                    const div = document.createElement('div');
                    div.style.marginBottom = "20px";
                    div.innerHTML = `<label class="form-label" style="font-weight:600;">${i+1}. ${q}</label><div class="radio-group"><label class="radio-option"><input type="radio" name="gad7_${i}" value="0"> Not at all</label><label class="radio-option"><input type="radio" name="gad7_${i}" value="1"> Several days</label><label class="radio-option"><input type="radio" name="gad7_${i}" value="2"> More than half the days</label><label class="radio-option"><input type="radio" name="gad7_${i}" value="3"> Nearly every day</label></div>`;
                    wrap.appendChild(div);
                });
                document.getElementById('gad7Modal').classList.add('active');
            }
            calculateGAD7(){
                let total = 0;
                for (let i=0; i<7; i++){
                    const sel = document.querySelector(`input[name="gad7_${i}"]:checked`);
                    if (!sel){ alert("Please answer all questions to see your results."); return; }
                    total += Number(sel.value);
                }
                let severity = "Minimal";
                if (total >= 5) severity = "Mild";
                if (total >= 10) severity = "Moderate";
                if (total >= 15) severity = "Severe";
                closeGAD7Modal();
                this.addMessage(`üìä GAD-7 Results:\n\nScore: ${total}/21\nSeverity: ${severity}\n\nThis is a screening tool. If anxiety is affecting your daily life, try "breathing" or "grounding" exercises, or type "resources" for professional help.`, false);
                if (!this.achievements.tookAssessment){
                    this.unlockAchievement('tookAssessment', 'üìã Self-Aware!', 'Completed screening');
                }
            }
            showCoping(){ document.getElementById('copingModal').classList.add('active'); }
            showCopingCategory(cat){
                closeCopingModal();
                const tips = {
                    anxiety: "üò∞ Anxiety & Panic Coping:\n\n1Ô∏è‚É£ 4-7-8 Breathing (inhale 4, hold 7, exhale 8)\n2Ô∏è‚É£ 5-4-3-2-1 Grounding technique\n3Ô∏è‚É£ Progressive muscle relaxation\n4Ô∏è‚É£ Challenge catastrophic thoughts\n5Ô∏è‚É£ Limit caffeine and practice self-compassion",
                    depression: "üòî Depression Coping:\n\n1Ô∏è‚É£ Behavioral activation (one small task)\n2Ô∏è‚É£ Practice self-compassion\n3Ô∏è‚É£ Connect with one supportive person\n4Ô∏è‚É£ Challenge negative self-talk\n5Ô∏è‚É£ Light exercise or movement\n6Ô∏è‚É£ Maintain sleep schedule",
                    stress: "üò§ Stress Management:\n\n1Ô∏è‚É£ Prioritize (urgent vs important)\n2Ô∏è‚É£ Set healthy boundaries\n3Ô∏è‚É£ Break tasks into small steps\n4Ô∏è‚É£ Take 5-minute mindful breaks\n5Ô∏è‚É£ Journal your thoughts\n6Ô∏è‚É£ Practice saying 'no'",
                    sleep: "üò¥ Sleep Hygiene:\n\n1Ô∏è‚É£ Same sleep/wake time daily\n2Ô∏è‚É£ No screens 1hr before bed\n3Ô∏è‚É£ Keep room cool and dark\n4Ô∏è‚É£ Write down racing thoughts\n5Ô∏è‚É£ Relaxation audio or meditation\n6Ô∏è‚É£ Avoid caffeine after 2pm"
                };
                this.addMessage(tips[cat] || "Coping strategies!", false);
            }
            showResources(){ document.getElementById('resourcesModal').classList.add('active'); }

            async generateReply(text) {
                const lower = text.toLowerCase().trim();
                const name = this.userName || "friend";

                if (this.detectCrisis(text)) {
                    setTimeout(() => this.showEmergencyContacts(), 300);
                    return `${name}, I'm really concerned about what you shared. Please use üö® Emergency Contacts immediately. Your life matters deeply. You're not alone in this.`;
                }

                const has = (...words) => words.some(w => lower.includes(w));

                // Greetings & small talk (rule-based)
                if (has("hi", "hello", "hey", "hii", "hiii", "yo", "good morning", "good afternoon", "good evening")) {
                    return `Hi ${name}! I'm here with you. How are you feeling today‚Äîanxious, stressed, low, or just want to talk? üíô`;
                }
                if (has("how are you", "how r you", "how're you", "whats up", "what's up", "wassup")) {
                    return `I'm here and ready to support you, ${name}. üíô How are *you* feeling right now?`;
                }
                if (has("thanks", "thank you", "ty")) {
                    return `You're welcome, ${name}. üíô You're doing a good job showing up for yourself. What would you like help with next?`;
                }
                if (has("bye", "goodbye", "see you", "gn", "good night")) {
                    return `Take care, ${name}. üíô If you need me again, just type a message‚ÄîI'm always here.`;
                }


                if (has("tools", "help tools")) {
                    setTimeout(() => this.showToolsMenu(), 250);
                    return `Here are all my tools, ${name}. Pick what feels right! üõ†Ô∏è`;
                }
                if (has("breathing", "breath")) {
                    setTimeout(() => this.showBreathingExercise(), 250);
                    if (!this.achievements.usedBreathing) {
                        this.unlockAchievement('usedBreathing', 'üå¨Ô∏è Calm Mind!', 'Used breathing');
                    }
                    return `Opening breathing exercise for you‚Ä¶ üå¨Ô∏è`;
                }
                if (has("meditation", "meditate")) {
                    setTimeout(() => this.showMeditation(), 250);
                    return `Opening meditation options‚Ä¶ üßò‚Äç‚ôÄÔ∏è`;
                }
                if (has("grounding", "5-4-3-2-1", "54321")) {
                    setTimeout(() => this.showGrounding(), 250);
                    return `Opening grounding exercise‚Ä¶ This will help anchor you! üåø`;
                }
                if (has("assessment", "screening", "phq", "gad")) {
                    setTimeout(() => this.showAssessments(), 250);
                    return `Opening mental health assessments‚Ä¶ üìã`;
                }
                if (has("coping", "strategies")) {
                    setTimeout(() => this.showCoping(), 250);
                    return `Opening coping strategies library‚Ä¶ üõ†Ô∏è`;
                }
                if (has("resources", "therapist", "counselor")) {
                    setTimeout(() => this.showResources(), 250);
                    return `Opening professional resources‚Ä¶ üìö`;
                }
                if (has("emergency", "helpline")) {
                    setTimeout(() => this.showEmergencyContacts(), 250);
                    return `Opening emergency contacts‚Ä¶ üö®`;
                }
                if (has("voice")) {
                    setTimeout(() => this.showVoiceSettings(), 250);
                    return `Opening voice settings‚Ä¶ üéôÔ∏è`;
                }
                if (has("personality")) {
                    setTimeout(() => this.showPersonality(), 250);
                    return `Opening personality options‚Ä¶ ü§ñ`;
                }
                if (has("achievement")) {
                    setTimeout(() => this.showAchievements(), 250);
                    return `Opening your achievements‚Ä¶ üèÜ`;
                }
                if (has("affirmation", "quote")) {
                    setTimeout(() => this.showDailyAffirmation(), 250);
                    return `Here's an affirmation for you‚Ä¶ ‚ú®`;
                }

                if (this.useAI) {
                    try {
                        const aiResponse = await this.generateAIResponse(text);
                        return aiResponse;
                    } catch (error) {
                        console.error('AI failed, using fallback:', error);
                        return this.getFallbackResponse(text);
                    }
                }

                for (const [category, keywords] of Object.entries(this.mentalHealthKeywords)) {
                    if (keywords.some(k => lower.includes(k))) {
                        if (this.personality === "motivational") return this.getMotivationalResponse(text, name);
                        if (this.personality === "clinical") return this.getClinicalResponse(text, name);
                        return this.getEmpatheticResponse(text, name);
                    }
                }

                return `Thanks for sharing, ${name}. Want to try "breathing", "grounding", or "assessment"? üíú`;
            }

            getEmpatheticResponse(text, name) {
                return `I can hear that this is weighing on you, ${name}. Your feelings are completely valid. üíú\n\nWould you like to talk more about it, or would a calming exercise help right now?`;
            }

            getMotivationalResponse(text, name) {
                return `Hey ${name}, I know things feel tough right now, but you're taking action by talking about it - that's huge! üí™\n\nLet's tackle this together. What would help you most right now?`;
            }

            getClinicalResponse(text, name) {
                return `Thank you for sharing, ${name}. Let's approach this systematically.\n\nWould you benefit from: (1) An assessment to understand what you're experiencing, (2) Evidence-based coping techniques, or (3) Professional resource referrals?`;
            }

            getContextualResponse(category, text, name) {
                // ... (keep all your existing contextual response code)
                return `I understand you're experiencing ${category}. Let me help you with that.`;
            }
        }

        const bot = new CalmCompanionBot();
        console.log('‚úÖ Bot loaded! Type hi to test');
    </script>
</body>
</html>
